NyAI_β（にゃんこ大戦争キャラ評価AI）メモ

##構造
Excel→ Rawdata → FeatureEncoder→TensorEncoder →NyankoDataset
→ Spirit_router →  FeatureFunction → Feature_concat
→ NormalizedFM → MLP →　optimizer(Adam) → MSEloss



##α版からの更新
・Normalizerで正規化、評価値もZ-scoreにすることでデータの偏りを吸収

・FeatureEncoderでstr混在問題を解決、TensorEncoderでテンソルにして"cuda"or"cpu"へ送ることでGPU/CPUに対応（バッチ未対応）

・Spirit_routerで、Feature_normalとFeature_spiritの分岐を実装

・FeatureFunction内の微調整と、量産(mass)評価と単体(solo)評価を分離、多くのFeatureFunctionを追加

・FeatureFunctionSpitritの新設→ルーノを評価できる

・教師データを50→100に増やした

・Rawdata classはpandasで読み込むだけのクラス。責務を分けるためにDataset classから分離

・NyankoDataset classを置くことで、将来的にバッファの役割になる。つまりここが責務の歪みを吸収する。
　現在は評価値をZ-scoreにするためのμ,σを計算して置いている。

・α版より、未知データに対する過大評価過小評価が減少

・1体出したときの敵キャラ処理性能を考慮できるようになった

・無効系やゾンビキラー等のギミック対応力もMLPに投入



##β版の概要
・新限定キャラのルーノが既存の評価軸を壊していたため、
　新しくFeatureFunctionSpiritを作り、精霊専門家で対応することした。

・ルーノの推論値は私の微調整により、10点を超えないようにデータ側のバランスを調整した。
　これは、今後追加されるキャラのために余白を作っている。
　α版ではルーノ第2形態は10.6点だったが、β版では平均9.7点くらいにしている。
　今後追加される召喚キャラが強ければ、ルーノも評価があがると予想される。

・α版で評価できていなかった特化性を多少考慮するようになったが、
　あくまでも汎用評価なので、対応属性が多い方が過大評価されがち

・波動や烈波、爆破はとりあえず固定値でやっているので精度が悪い。
　今後、学習可能パラメータにする予定

・MSEloss単体の評価はあてにならなくなってきたため、lossはあくまでも参考値




## FeatureFunctionSpiritについて
・精霊は量産に関する制約があるため、FeatureFunctionのnormal側の量産(mass)に対応するFeature classを作る必要がある。

・いままでのにゃんこ大戦争では、HP高い→強いだったが、ルーノ第一形態は、本体弱め→精霊量産できる→壊れになっており、
　量産精霊が絡むと、体力に関して評価軸が反転している。つまり、既存キャラと同じ評価軸では測れない。

・本体との相互作用で精霊の壊れ具合が決まるため、相互作用を定義する必要がある。ルーノは本体性能と噛み合っているから壊れている。

　本体性能がポテンシャル場を作り、そのポテンシャルによって精霊の強さが決まるとイメージした。電荷の相互作用のようなもの。
　なので、まずは本体と精霊がどの程度離れているか扱うために、この空間での距離を定義した。

　それが次の式

　distance = 本体再生産*(本体が倒される時間 - 本体再生産)　
　
　である。
  本体が倒される時間は仮想敵DPS=10000にして、本体のHPから算出。この距離のイメージは、本体再生産と本体が倒される時間（精霊の再生産）
　が近ければ近いほど、精霊量産効率が良く、本体再生産をかけて2次関数にすることで、ピークを表現。
　distanseは言い換えると、どのくらい精霊が量産できるかという項になっている。
　距離を定義したのは良いものの、クーロンポテンシャルや湯川ポテンシャルだと発散してしまうため、AI学習ができない。
　なので、収束させる必要がある。既存キャラのように量産できないタイプは、距離が遠く、
　そのときに指数関数的に減衰してほしいため、exp(-r)は使いたい。となると、収束させるのにお手軽なガウシアンを採用。
　また、hp低すぎるキャラは量産できても攻撃できないので、exp((hp-hp0)^2/σ^2)をかけてhp方向も収束させる。

　以上より、

　exp((r-r0)^2/σ1^2)*exp((hp-hp0)^2/σ2^2)
　
　という式が、精霊の量産性能の基底ベクトルになると定義した。
　r= distanceであり、r0とhp0を学習可能パラメータにしているため、仮想敵DPSの主観をある程度吸収できている。
　FeatureFunctionSpirit内では、これに精霊の攻撃力や精霊の妨害力をかけることで、
　量産軸の火力ベクトルや妨害ベクトルの大きさを作り、重みをつけて線形結合で精霊の火力性能等を表現。
　本体の火力性能等は、AttackFeature_solo等で評価済み。

　専門性を完全に分ける際に、現在の共通Featureは専門固有Featureとして分離予定。



##今後の改善点と展望
・routerを作ることでMoEの下地を作った。専門ごとのMLPに分かれて学習させる。
　対赤性能、精霊持ち、遠方アタッカー、高耐久キャラ等さまざまな専門家を作ることができる。
　また、classを追加すればいいだけなので、新要素が来ても即座に対応できる。
　最終的には、専門家の意見を統合MLPに通し、汎用評価を出す。

・そもそも精霊持ちのキャラが少ない為、ダミーデータを教師データに混ぜてある。ここに私の主観が含まれているため、
　現在のルーノの評価値は、私が調整したことと同義である。今後精霊持ちが増えれば、ダミーデータの比率を減らす予定。

・学習の初期値運ゲーをどうにかしたい

・バッチ対応させようとしたが、MoE、router、学習modelの一部であるFeatureFunction、Featureconcat、Normalizerを責務を守りながら通すコードが
　私にはまだ書けなかったため、とりあえずGPU対応だけして一旦撤退した。
　GPTも汎用的なコードしか出せないため、現在のAIの学習方法では私の求めるコードは出力できないと感じた。
　なので、専門家を完全に独立させて、Excel側でバッチを分けるという対応になると思われる。
　もしくは、routerと専門家の間にバッチ吸収クラスを作り、routerから受け取ったindexを使って、専門家にバッチ内バッチ単位で順番に処理する方法もあり。

・NyAI_γでは、専門家の数を増やすのと、それに伴い教師データを増やしたいと考えている。
　専門家を増やすことで、中間評価で尖り評価や対属性評価も見れるようになるはず。
　現在の汎用評価だけでは埋もれがちな特化キャラを見つけられるようになる。










